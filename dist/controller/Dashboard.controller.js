sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/viz/ui5/controls/VizFrame","sap/viz/ui5/data/FlattenedDataset","sap/viz/ui5/controls/common/feeds/FeedItem","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(e,t,a,r,n,i,o,s){"use strict";return e.extend("sap.vic.dashboard.controller.Dashboard",{onInit:function(){var e=new t({headerExpanded:true});this.getView().setModel(e,"state");var a=new t({view:"chart"});this.getView().setModel(a,"view");var r=new t;r.loadData("model/mockData.json");r.attachRequestCompleted(function(){var e=r.getProperty("/ChartData")||[];r.setProperty("/ChartDataFull",e.slice(0));r.setProperty("/ChartData",e.slice(0));this._updatePieChartData(e)}.bind(this));this.getView().setModel(r,"mock");this.getOwnerComponent().getEventBus().subscribe("vic","odataAvailable",this._onODataAvailable,this);this.getView().attachAfterRendering(function(){var e=this.getView().byId("pieChart");e.setVizProperties({title:{text:"Data by Product Area (Pie)"}});var t=this.getView().byId("columnChart");t.setVizProperties({title:{text:"Data by Product Area (Column)"}});var a=this.getView().byId("idPopOver");if(a){a.connect(e.getVizUid());a.connect(t.getVizUid())}}.bind(this))},onValueHelpRequested:function(e){var t=e.getSource().getId();var r=this.getView();if(t.includes("testType")){if(!this._pValueHelpDialog){this._pValueHelpDialog=a.load({id:r.getId(),name:"sap.vic.dashboard.view.ValueHelpDialog",controller:this}).then(function(e){r.addDependent(e);return e})}this._pValueHelpDialog.then(function(e){e.open()})}else if(t.includes("testPlan")){if(!this._pTestPlanValueHelpDialog){this._pTestPlanValueHelpDialog=a.load({id:r.getId(),name:"sap.vic.dashboard.view.TestPlanValueHelpDialog",controller:this}).then(function(e){r.addDependent(e);return e})}this._pTestPlanValueHelpDialog.then(function(e){e.open()})}},onValueHelpOkPress:function(e){var t=e.getParameter("tokens");var a=this._getFieldName(e.getSource().getId());var r=this.byId(a);r.setTokens(t);e.getSource().close()},onValueHelpCancelPress:function(e){e.getSource().close()},onSearch:function(e){var t=this.byId("testTypeSelect");var a=this.byId("testPlanSelect");var r=this.byId("dateRange");var n=t.getSelectedKey();var i=a.getSelectedKey();var o=r.getDateValue();var s=r.getSecondDateValue();if(this._isLiveMode()){var l=[];if(n){l.push("SDDocumentCategory eq '"+encodeURIComponent(n)+"'")}if(o){l.push("WeekOfOrder ge '"+this._fmtDate(o)+"'")}if(s){l.push("WeekOfOrder le '"+this._fmtDate(s)+"'")}var u=l.join(" and ");var d=this.getOwnerComponent().getModel();var c=this;d.read("/ZI_VIC_UnconfirmedDemandSet",{urlParameters:u?{$filter:u,$format:"json"}:{$format:"json"},success:function(e){var t=c._transformToChartData(e.results||[]);var a=c.getView().getModel("mock");a.setProperty("/ChartData",t);a.setProperty("/ChartDataFull",t.slice(0));c._updatePieChartData(t)},error:function(e){}});return}var p=this.getView().getModel("mock");var h=p.getProperty("/TestPlans")||[];var m=h.filter(function(e){var t=n?e.testType===n:true;var a=i?e.id===i:true;return t&&a});var g=[];var f=p.getProperty("/ChartDataFull")||p.getProperty("/ChartData")||[];m.forEach(function(e){var t=f.find(function(t){return t.ProductArea===e.productArea});if(t){g.push(t)}});p.setProperty("/ChartData",g);this._updatePieChartData(g)},_updatePieChartData:function(e){var t=this.getView().getModel("mock");if(!t){return}var a=e||t.getProperty("/ChartData");if(!a){return}var r={Sim100:0,Sim99:0,SimLess:0};a.forEach(function(e){r.Sim100+=e.Sim100||0;r.Sim99+=e.Sim99||0;r.SimLess+=e.SimLess||0});var n=[{Status:"Sim100",Count:r.Sim100},{Status:"Sim99",Count:r.Sim99},{Status:"SimLess",Count:r.SimLess}];t.setProperty("/PieChartData",n)},_isLiveMode:function(){var e=this.getOwnerComponent().getModel("state");return e&&e.getProperty("/liveMode")},_onODataAvailable:function(){var e=this.getOwnerComponent().getModel();var t=this;var a="/ZI_VIC_UnconfirmedDemandSet";e.read(a,{urlParameters:{$top:"200",$format:"json"},success:function(e){var a=t._transformToChartData(e.results||[]);var r=t.getView().getModel("mock");r.setProperty("/ChartData",a);r.setProperty("/ChartDataFull",a.slice(0));t._updatePieChartData(a)},error:function(){}})},_transformToChartData:function(e){return(e||[]).map(function(e){return{ProductArea:e.SDDocumentCategory||e.ProductArea||"N/A",Sim100:Number(e.ConfirmedDemand)||0,Sim99:Number(e.DelayedDemand)||0,SimLess:Number(e.UnconfirmedDemand)||0}})},_fmtDate:function(e){var t=function(e){return e<10?"0"+e:e};return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())},onReset:function(e){},onChartSelectChange:function(e){},_getFieldName:function(e){if(e.includes("testType")){return"testTypeInput"}else if(e.includes("testPlan")){return"testPlanInput"}},onTestTypeChange:function(e){var a=e.getParameter("selectedItem").getKey();var r=this.byId("testPlanSelect");var n=this.getView().getModel("mock");var i=n.getProperty("/TestPlans")||[];var o=i.filter(function(e){return e.testType===a});r.bindItems({path:"testPlan>/TestPlans",template:new sap.ui.core.Item({key:"{testPlan>id}",text:"{testPlan>name}"})});r.setModel(new t({TestPlans:o}),"testPlan");r.setEnabled(true)},onViewChange:function(e){var t=e.getParameter("key");this.getView().getModel("view").setProperty("/view",t)},createColumnConfig:function(){return[{label:"Product Area",property:"ProductArea",type:"string"},{label:"Sim 100",property:"Sim100",type:"number"},{label:"Sim 99",property:"Sim99",type:"number"},{label:"Sim Less",property:"SimLess",type:"number"}]},onExport:function(){var e=this.byId("tableView");var t=e.getBinding("items");var a=this.createColumnConfig();if(!t){sap.m.MessageToast.show("No data to export.");return}var r=t.getModel();var n=r.getProperty(t.getPath());if(!n||n.length===0){sap.m.MessageToast.show("No data to export.");return}var i={workbook:{columns:a},dataSource:n,fileName:"DashboardData.xlsx",worker:false};var o=new s(i);o.build().then(function(){sap.m.MessageToast.show("Data exported successfully.")}).finally(function(){o.destroy()})}})});
//# sourceMappingURL=Dashboard.controller.js.map